<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NC Mineral & Gem Localities Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
html,body,#map{height:100%;margin:0;padding:0;font-family:Arial,sans-serif}
#map{height:100vh}

/* Control Panels */
.control-panel {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    max-width: 280px;
}

.search-panel {
    margin-bottom: 10px;
}

.search-box {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
}

.search-box:focus {
    outline: none;
    border-color: #4CAF50;
}

.filter-panel {
    max-height: 400px;
    overflow-y: auto;
}

.filter-header {
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.filter-buttons {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
}

.filter-btn {
    padding: 4px 8px;
    font-size: 11px;
    border: 1px solid #ddd;
    background: #f5f5f5;
    border-radius: 3px;
    cursor: pointer;
}

.filter-btn:hover {
    background: #e0e0e0;
}

.filter-item {
    margin: 8px 0;
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
}

.filter-item:hover {
    background: #f5f5f5;
}

.filter-checkbox {
    margin-right: 8px;
    cursor: pointer;
}

.filter-color {
    display: inline-block;
    width: 18px;
    height: 18px;
    margin-right: 8px;
    border: 2px solid #000;
    border-radius: 50%;
    vertical-align: middle;
}

.filter-label {
    flex: 1;
    font-size: 14px;
}

/* Enhanced Legend */
.legend {
    background: white;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    line-height: 24px;
    font-family: Arial, sans-serif;
    font-size: 14px;
}

.legend-title {
    margin: 0 0 10px 0;
    font-size: 16px;
    font-weight: bold;
}

.legend-item {
    margin: 6px 0;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
}

.legend-item:hover {
    background: #f5f5f5;
}

.legend-item.inactive {
    opacity: 0.4;
}

.legend-color {
    display: inline-block;
    width: 18px;
    height: 18px;
    margin-right: 8px;
    border: 2px solid #000;
    border-radius: 50%;
    vertical-align: middle;
}

/* Enhanced Popups */
.custom-popup {
    font-family: Arial, sans-serif;
}

.popup-title {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 8px;
    color: #333;
}

.popup-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    margin-bottom: 8px;
}

.popup-description {
    font-size: 13px;
    line-height: 1.4;
    color: #666;
}

/* Tooltips */
.leaflet-tooltip {
    background: rgba(0,0,0,0.8);
    border: none;
    color: white;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
}

/* Reset Button */
.reset-btn {
    background: white;
    padding: 8px 12px;
    border-radius: 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    cursor: pointer;
    font-size: 13px;
    border: 2px solid #ddd;
    font-weight: bold;
}

.reset-btn:hover {
    background: #f5f5f5;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .control-panel {
        max-width: 90%;
        font-size: 12px;
    }
    .legend {
        font-size: 12px;
    }
}

/* Marker Clusters */
.marker-cluster-small {
    background-color: rgba(181, 226, 140, 0.6);
}
.marker-cluster-small div {
    background-color: rgba(110, 204, 57, 0.6);
}
.marker-cluster-medium {
    background-color: rgba(241, 211, 87, 0.6);
}
.marker-cluster-medium div {
    background-color: rgba(240, 194, 12, 0.6);
}
.marker-cluster-large {
    background-color: rgba(253, 156, 115, 0.6);
}
.marker-cluster-large div {
    background-color: rgba(241, 128, 23, 0.6);
}
</style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const data = {"type": "FeatureCollection", "features": [{"type": "Feature", "properties": {"name": "Reed Gold Mine", "mineral_type": "gold", "description": "First documented gold find in the United States (1799). Historic site near Concord. Open for gold panning."}, "geometry": {"type": "Point", "coordinates": [-80.4584, 35.2687]}}, {"type": "Feature", "properties": {"name": "Emerald Hollow Mine", "mineral_type": "emerald", "description": "Only emerald mine in the world open for public prospecting. Hiddenite area. Active 2025."}, "geometry": {"type": "Point", "coordinates": [-81.9736, 35.6089]}}, {"type": "Feature", "properties": {"name": "Howie Mine", "mineral_type": "gold", "description": "Historic gold mine in Cabarrus County. Active in 1800s."}, "geometry": {"type": "Point", "coordinates": [-81.0234, 35.2845]}}, {"type": "Feature", "properties": {"name": "Crabtree Emerald Mine", "mineral_type": "emerald", "description": "Famous for emeralds and aquamarine. Mitchell County. Emerald Village open April-November 2025."}, "geometry": {"type": "Point", "coordinates": [-82.1456, 35.8234]}}, {"type": "Feature", "properties": {"name": "Cherokee Ruby & Sapphire Mine", "mineral_type": "ruby_sapphire", "description": "Active ruby and sapphire mine in Franklin. Open March-December 2025. Lilac sapphires."}, "geometry": {"type": "Point", "coordinates": [-83.3814, 35.1823]}}, {"type": "Feature", "properties": {"name": "Gold Hill Mining District", "mineral_type": "gold", "description": "Historic gold mining town. Active 1842-1915. Rowan County."}, "geometry": {"type": "Point", "coordinates": [-80.3345, 35.5234]}}, {"type": "Feature", "properties": {"name": "Thermal City Gold Mine", "mineral_type": "gold", "description": "Active gold panning site. Rutherford County. Open to public 2025."}, "geometry": {"type": "Point", "coordinates": [-81.8234, 35.5456]}}, {"type": "Feature", "properties": {"name": "Sheffield Mine", "mineral_type": "ruby_sapphire", "description": "Historic native ruby/sapphire mine. Franklin area. Open March-November 2025."}, "geometry": {"type": "Point", "coordinates": [-83.3912, 35.1789]}}, {"type": "Feature", "properties": {"name": "Mason Mountain Mine", "mineral_type": "garnet", "description": "Rhodolite garnet locality. Mitchell County. Rare pink garnet variety."}, "geometry": {"type": "Point", "coordinates": [-82.0123, 35.6234]}}, {"type": "Feature", "properties": {"name": "Brindletown", "mineral_type": "gold", "description": "Historic placer gold area. Burke County."}, "geometry": {"type": "Point", "coordinates": [-81.789, 35.4567]}}, {"type": "Feature", "properties": {"name": "Mason's Ruby & Sapphire Mine", "mineral_type": "ruby_sapphire", "description": "Dig-your-own ruby and sapphire mine. Franklin. Active 2025."}, "geometry": {"type": "Point", "coordinates": [-83.3892, 35.1756]}}, {"type": "Feature", "properties": {"name": "Rose Creek Mine", "mineral_type": "ruby_sapphire", "description": "Historic mine operating since 1952. Franklin. Raw ore digging."}, "geometry": {"type": "Point", "coordinates": [-83.3723, 35.1645]}}, {"type": "Feature", "properties": {"name": "Old Cardinal Gem Mine", "mineral_type": "gems", "description": "Multi-gem mine in Franklin. Active 2025."}, "geometry": {"type": "Point", "coordinates": [-83.3956, 35.1834]}}, {"type": "Feature", "properties": {"name": "Elijah Mountain Gem Mine", "mineral_type": "gems", "description": "Gem mine in Hendersonville. Active 2025."}, "geometry": {"type": "Point", "coordinates": [-82.4612, 35.3189]}}, {"type": "Feature", "properties": {"name": "Pisgah Forest Gem Mine", "mineral_type": "gems", "description": "Gem mine near Hendersonville. Active 2025."}, "geometry": {"type": "Point", "coordinates": [-82.6534, 35.2756]}}, {"type": "Feature", "properties": {"name": "Sugar Creek Gem Mine", "mineral_type": "gems", "description": "Gem mine in Banner Elk. Active 2025."}, "geometry": {"type": "Point", "coordinates": [-81.8745, 36.1623]}}, {"type": "Feature", "properties": {"name": "Gold City", "mineral_type": "gold", "description": "Gold panning site in Franklin. Active 2025."}, "geometry": {"type": "Point", "coordinates": [-83.3845, 35.1912]}}, {"type": "Feature", "properties": {"name": "Kings Mountain Lithium Mine", "mineral_type": "lithium", "description": "Major lithium deposit. Reopening 2024-2026 for EV battery production."}, "geometry": {"type": "Point", "coordinates": [-81.3612, 35.2423]}}, {"type": "Feature", "properties": {"name": "Spruce Pine Quartz District", "mineral_type": "quartz", "description": "Ultra-high-purity quartz for semiconductors. Globally critical. Active 2025."}, "geometry": {"type": "Point", "coordinates": [-82.0645, 35.9156]}}, {"type": "Feature", "properties": {"name": "Piedmont Lithium Project", "mineral_type": "lithium", "description": "Proposed lithium hydroxide production. Gaston County. 60,000 metric tons/year capacity."}, "geometry": {"type": "Point", "coordinates": [-81.1234, 35.3789]}}, {"type": "Feature", "properties": {"name": "Monazite Deposits - Cabarrus County", "mineral_type": "rare_earth", "description": "Rare-earth element deposits. Monazite vein deposits. Historic mining area."}, "geometry": {"type": "Point", "coordinates": [-80.5789, 35.3456]}}, {"type": "Feature", "properties": {"name": "Heavy Mineral Deposits - Coastal Plain", "mineral_type": "heavy_minerals", "description": "Ilmenite, rutile, and zircon deposits. 25 million short tons estimated reserves."}, "geometry": {"type": "Point", "coordinates": [-77.8956, 35.1234]}}, {"type": "Feature", "properties": {"name": "Hiddenite Locality", "mineral_type": "hiddenite", "description": "Only source of gem-quality hiddenite (grass-green gemstone) in the world. Alexander County."}, "geometry": {"type": "Point", "coordinates": [-81.0823, 35.9089]}}]};
const colorMap = {"gold": "#FFD700", "emerald": "#50C878", "ruby_sapphire": "#E0115F", "garnet": "#B22222", "gems": "#9370DB", "lithium": "#C0C0C0", "quartz": "#87CEEB", "rare_earth": "#FF6347", "heavy_minerals": "#8B4513", "hiddenite": "#98FF98"};

// State management
const mapState = {
    activeFilters: new Set(Object.keys(colorMap)),
    allMarkers: [],
    markerCluster: null
};

// Initialize map
const map = L.map('map').setView([35.5,-80.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19,
    attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// Create marker cluster group
mapState.markerCluster = L.markerClusterGroup({
    maxClusterRadius: 50,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true
});

// Helper function to get badge color
function getBadgeColor(mineralType) {
    const color = colorMap[mineralType] || '#9370DB';
    // Darken the color for better text contrast
    return color;
}

// Helper function to format mineral type
function formatMineralType(type) {
    return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// Create markers
if (data && data.features && data.features.length > 0) {
    data.features.forEach(feature => {
        const props = feature.properties || {};
        const coords = feature.geometry.coordinates;
        const latlng = [coords[1], coords[0]];
        const mineralType = props.mineral_type || 'gems';
        const color = colorMap[mineralType] || '#9370DB';
        
        // Create marker
        const marker = L.circleMarker(latlng, {
            radius: 12,
            fillColor: color,
            color: "#000",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        });
        
        // Enhanced popup
        const popupContent = `
            <div class="custom-popup">
                <div class="popup-title">${props.name || 'Unknown'}</div>
                <div class="popup-badge" style="background-color: ${getBadgeColor(mineralType)}">
                    ${formatMineralType(mineralType)}
                </div>
                <div class="popup-description">${props.description || 'No description available'}</div>
            </div>
        `;
        marker.bindPopup(popupContent);
        
        // Hover tooltip
        marker.bindTooltip(props.name || 'Unknown', {
            permanent: false,
            direction: 'top',
            offset: [0, -10]
        });
        
        // Store mineral type for filtering
        marker.mineralType = mineralType;
        marker.searchName = (props.name || '').toLowerCase();
        
        mapState.allMarkers.push(marker);
    });
    
    // Add all markers to cluster initially
    updateMarkers();
    map.fitBounds(mapState.markerCluster.getBounds(), {maxZoom: 8});
}

// Update markers based on filters
function updateMarkers() {
    mapState.markerCluster.clearLayers();
    const filteredMarkers = mapState.allMarkers.filter(m => 
        mapState.activeFilters.has(m.mineralType)
    );
    mapState.markerCluster.addLayers(filteredMarkers);
    if (!map.hasLayer(mapState.markerCluster)) {
        map.addLayer(mapState.markerCluster);
    }
}

// Filter functions
function toggleFilter(mineralType) {
    if (mapState.activeFilters.has(mineralType)) {
        mapState.activeFilters.delete(mineralType);
    } else {
        mapState.activeFilters.add(mineralType);
    }
    updateMarkers();
    updateLegendUI();
    updateFilterUI();
}

function selectAllFilters() {
    mapState.activeFilters = new Set(Object.keys(colorMap));
    updateMarkers();
    updateLegendUI();
    updateFilterUI();
}

function deselectAllFilters() {
    mapState.activeFilters.clear();
    updateMarkers();
    updateLegendUI();
    updateFilterUI();
}

function updateFilterUI() {
    Object.keys(colorMap).forEach(type => {
        const checkbox = document.getElementById('filter-' + type);
        if (checkbox) {
            checkbox.checked = mapState.activeFilters.has(type);
        }
    });
}

function updateLegendUI() {
    Object.keys(colorMap).forEach(type => {
        const item = document.getElementById('legend-' + type);
        if (item) {
            if (mapState.activeFilters.has(type)) {
                item.classList.remove('inactive');
            } else {
                item.classList.add('inactive');
            }
        }
    });
}

// Search function
function searchLocalities(query) {
    query = query.toLowerCase().trim();
    if (!query) {
        // Reset to show all filtered markers
        updateMarkers();
        return;
    }
    
    // Find matching markers
    const matches = mapState.allMarkers.filter(m => 
        m.searchName.includes(query) && mapState.activeFilters.has(m.mineralType)
    );
    
    if (matches.length > 0) {
        // Clear and show only matches
        mapState.markerCluster.clearLayers();
        mapState.markerCluster.addLayers(matches);
        
        // Zoom to results
        if (matches.length === 1) {
            map.setView(matches[0].getLatLng(), 12);
            matches[0].openPopup();
        } else {
            const group = L.featureGroup(matches);
            map.fitBounds(group.getBounds(), {maxZoom: 10});
        }
    }
}

// Add search control
const searchControl = L.control({position: 'topleft'});
searchControl.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'control-panel search-panel');
    div.innerHTML = `
        <input type="text" 
               class="search-box" 
               id="searchBox" 
               placeholder="Search localities..."
               autocomplete="off">
    `;
    
    L.DomEvent.disableClickPropagation(div);
    
    return div;
};
searchControl.addTo(map);

// Add search event listener
setTimeout(() => {
    const searchBox = document.getElementById('searchBox');
    if (searchBox) {
        let searchTimeout;
        searchBox.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchLocalities(e.target.value);
            }, 300);
        });
        
        searchBox.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchLocalities(e.target.value);
            }
        });
    }
}, 100);

// Add filter control
const filterControl = L.control({position: 'topleft'});
filterControl.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'control-panel filter-panel');
    
    let html = '<div class="filter-header">Filter by Type</div>';
    html += '<div class="filter-buttons">';
    html += '<button class="filter-btn" onclick="selectAllFilters()">All</button>';
    html += '<button class="filter-btn" onclick="deselectAllFilters()">None</button>';
    html += '</div>';
    
    const types = [
        ['gold', 'Gold'],
        ['emerald', 'Emerald'],
        ['ruby_sapphire', 'Ruby/Sapphire'],
        ['garnet', 'Garnet'],
        ['gems', 'Multi-Gem'],
        ['lithium', 'Lithium'],
        ['quartz', 'Quartz'],
        ['rare_earth', 'Rare Earth'],
        ['heavy_minerals', 'Heavy Minerals'],
        ['hiddenite', 'Hiddenite']
    ];
    
    types.forEach(([key, label]) => {
        const color = colorMap[key] || '#9370DB';
        html += `
            <div class="filter-item" onclick="toggleFilter('${key}')">
                <input type="checkbox" 
                       class="filter-checkbox" 
                       id="filter-${key}" 
                       checked 
                       onclick="event.stopPropagation(); toggleFilter('${key}')">
                <span class="filter-color" style="background-color:${color}"></span>
                <span class="filter-label">${label}</span>
            </div>
        `;
    });
    
    div.innerHTML = html;
    L.DomEvent.disableClickPropagation(div);
    
    return div;
};
filterControl.addTo(map);

// Add interactive legend
const legend = L.control({position: 'bottomright'});
legend.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = '<h4 class="legend-title">Mineral Types</h4>';
    
    const types = [
        ['gold', 'Gold'],
        ['emerald', 'Emerald'],
        ['ruby_sapphire', 'Ruby/Sapphire'],
        ['garnet', 'Garnet'],
        ['gems', 'Multi-Gem'],
        ['lithium', 'Lithium'],
        ['quartz', 'Quartz'],
        ['rare_earth', 'Rare Earth'],
        ['heavy_minerals', 'Heavy Minerals'],
        ['hiddenite', 'Hiddenite']
    ];
    
    types.forEach(([key, label]) => {
        const color = colorMap[key] || '#9370DB';
        div.innerHTML += `
            <div class="legend-item" id="legend-${key}" onclick="toggleFilter('${key}')">
                <span class="legend-color" style="background-color:${color}"></span>
                ${label}
            </div>
        `;
    });
    
    L.DomEvent.disableClickPropagation(div);
    
    return div;
};
legend.addTo(map);

// Add reset view button
const resetControl = L.control({position: 'topright'});
resetControl.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'leaflet-bar');
    div.innerHTML = '<button class="reset-btn" onclick="resetView()">Reset View</button>';
    L.DomEvent.disableClickPropagation(div);
    return div;
};
resetControl.addTo(map);

function resetView() {
    document.getElementById('searchBox').value = '';
    selectAllFilters();
    if (mapState.markerCluster.getBounds().isValid()) {
        map.fitBounds(mapState.markerCluster.getBounds(), {maxZoom: 8});
    }
}
</script>
</body>
</html>